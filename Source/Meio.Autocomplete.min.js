(function(D){var E=D.document.id||D.$;var G=Browser.Engine;$extend(Element.NativeEvents,{"paste":2,"input":2});Element.Events.paste={base:(G.presto||(G.gecko&&G.version<19))?"input":"paste",condition:function(H){this.fireEvent("paste",H,1);return false}};Element.Events.keyrepeat={base:(G.gecko||G.presto)?"keypress":"keydown",condition:$lambda(true)};var A={};var F;var B={9:1,16:1,17:1,18:1,224:1,91:1,37:1,38:1,39:1,40:1};var C=function(H){return H.replace(/"/g,"&quot;").replace(/'/g,"&#39;")};A.Widget=new Class({initialize:function(){this.elements={}},addElement:function(H,I){this.elements[H]=I},addEventToElement:function(I,H,J){this.elements[I].addEvent(H,J.bindWithEvent(this))},addEventsToElement:function(H,I){for(eventName in I){this.addEventToElement(H,eventName,I[eventName])}},attach:function(){for(element in this.elements){this.elements[element].attach()}},detach:function(){for(element in this.elements){this.elements[element].detach()}},destroy:function(){for(element in this.elements){this.elements[element]&&this.elements[element].destroy()}}});A.Autocomplete=new Class({Extends:A.Widget,Implements:[Options,Events],options:{delay:200,minChars:0,cacheLength:20,selectOnTab:true,maxVisibleItems:10,cacheType:"shared",listInstance:null,filter:{type:"contains"},elementOptions:{},listOptions:{},requestOptions:{},urlOptions:{}},initialize:function(H,J,I){this.parent();this.setOptions(I);this.active=0;this.filters=A.Autocomplete.Filter.get(this.options.filter);this.addElement("list",this.options.listInstance||new A.Element.List(this.options.listOptions));this.addListEvents();this.addElement("field",new A.Element.Field(H,this.options.elementOptions));this.addFieldEvents();this.addSelectEvents();this.attach();this.initCache();this.initData(J)},addFieldEvents:function(){this.addEventsToElement("field",{"beforeKeyrepeat":function(J){this.active=1;var H=J.key,I=this.elements.list;if(H=="up"||H=="down"||(H=="enter"&&I.showing)){J.preventDefault()}},"delayedKeyrepeat":function(J){var H=J.key,I=this.elements.field;I.keyPressControl[H]=true;switch(H){case"up":case"down":this.focusItem(H);break;case"enter":this.setInputValue();break;case"tab":if(this.options.selectOnTab){this.setInputValue()}I.keyPressControl[H]=false;break;case"esc":this.elements.list.hide();break;default:this.setupList()}this.oldInputedText=I.node.get("value")},"keyup":function(I){var H=this.elements.field;if(!B[I.code]){if(!H.keyPressControl[I.key]){this.setupList()}H.keyPressControl[I.key]=false}},"focus":function(){this.active=1;var H=this.elements.list;H.focusedItem=null;H.positionNextTo(this.elements.field.node)},"click":function(){var H=this.elements.list;if(this.active++>1&&!H.showing){this.forceSetupList()}},"blur":function(I){this.active=0;var H=this.elements.list;if(H.shouldNotBlur){this.elements.field.node.setCaretPosition("end");H.shouldNotBlur=false;if(H.focusedItem){H.hide()}}else{H.hide()}},"paste":function(){return this.setupList()}})},addListEvents:function(){this.addEventsToElement("list",{"mousedown":function(H){if(this.active&&!H.dontHide){this.setInputValue()}}})},update:function(){var U=this.inputedText,N=this.data,W=this.options,P=this.elements.list;var I=this.filters.filter,H=this.filters.formatMatch,R=this.filters.formatItem;var Q=N.getKey(),K=this.cache.get(Q),O;if(K){O=K.html;this.itemsData=K.data}else{N=N.get();var T=[],S=[],L=P.options.classes;for(var V,M=0,J=0;V=N[M++];){if(I.call(this,U,V)){T.push('<li title="',C(H.call(this,U,V)),'" data-index="',J,'" class="',(J%2?L.even:L.odd),'">',R.call(this,U,V,J),"</li>");S.push(V);J++}}O=T.join("");this.cache.set(Q,{html:O,data:S});this.itemsData=S}P.focusedItem=null;this.fireEvent("deselect",[this.elements]);P.list.set("html",O);if(this.options.maxVisibleItems){P.applyMaxHeight(this.options.maxVisibleItems)}},setupList:function(){this.inputedText=this.elements.field.node.get("value");if(this.inputedText!==this.oldInputedText){this.forceSetupList(this.inputedText)}else{this.elements.list.hide()}return true},forceSetupList:function(H){H=H||this.elements.field.node.get("value");if(H.length>=this.options.minChars){$clear(this.prepareTimer);this.prepareTimer=this.data.prepare.delay(this.options.delay,this.data,this.inputedText)}},dataReady:function(){this.update();if(this.onUpdate){this.onUpdate();this.onUpdate=null}var H=this.elements.list;if(H.list.get("html")){if(this.active){H.show()}}else{this.fireEvent("noItemToList",[this.elements]);H.hide()}},setInputValue:function(){var H=this.elements.list;if(H.focusedItem){var I=H.focusedItem.get("title");this.elements.field.node.set("value",I);this.fireEvent("select",[this.elements,this.itemsData[H.focusedItem.get("data-index")],I])}H.hide()},focusItem:function(I){var H=this.elements.list;if(H.showing){H.focusItem(I)}else{this.forceSetupList();this.onUpdate=function(){H.focusItem(I)}}},addSelectEvents:function(){this.addEvents({onSelect:function(H){H.field.addSelectedClass()},onDeselect:function(H){H.field.removeSelectedClass()}})},initData:function(H){this.data=($type(H)=="string")?new A.Autocomplete.Data.Request(H,this.cache,this.elements.field,this.options.requestOptions,this.options.urlOptions):new A.Autocomplete.Data(H,this.cache);this.data.addEvent("ready",this.dataReady.bind(this))},initCache:function(){var H=this.options.cacheLength;if(this.options.cacheType=="shared"){this.cache=F;this.cache.setMaxLength(H)}else{this.cache=new A.Autocomplete.Cache(H)}},refreshCache:function(H){this.cache.refresh();this.cache.setMaxLength(H||this.options.cacheLength)},refreshAll:function(I,H){this.refreshCache(I);this.data.refreshKey(H)}});A.Autocomplete.Select=new Class({Extends:A.Autocomplete,options:{syncName:"id",valueField:null,valueFilter:function(H){return H.id}},initialize:function(H,J,I){this.parent(H,J,I);if(this.options.syncName){this.syncWithValueField(J)}this.addEvent("select",function(L,K){this.options.valueField.set("value",this.options.valueFilter.call(this,K))})},syncWithValueField:function(J){var H=this.options.valueField;var I=H.get("value");if(!H||!I){return }this.addParameter(J);this.addDataReadyEvent(I);this.data.prepare(this.elements.field.node.get("value"))},addParameter:function(H){this.parameter={name:this.options.syncName,value:function(){return this.options.valueField.value}.bind(this)};if(this.data.url){this.data.url.addParameter(this.parameter)}},addDataReadyEvent:function(J){var I=this;this.data.addEvent("ready",function H(){var K=this.get();for(var L=K.length;L--;){if(I.options.valueFilter.call(I,K[L])==J){I.elements.field.node.set("value",I.options.formatMatch.call(I,"",K[L],0))}}if(this.url){this.url.removeParameter(I.parameter)}this.removeEvent("ready",H)})}});A.Element=new Class({Implements:[Events],initialize:function(H){this.setNode(H);this.createBoundEvents();this.attach()},setNode:function(H){this.node=H?E(H)||$$(H)[0]:this.render()},createBoundEvents:function(){this.bound={};this.boundEvents.each(function(H){this.bound[H]=function(I){this.fireEvent("before"+H.capitalize(),I);this[H]&&this[H](I);this.fireEvent(H,I);return true}.bindWithEvent(this)},this)},attach:function(){for(e in this.bound){this.node.addEvent(e,this.bound[e])}},detach:function(){for(e in this.bound){this.node.removeEvent(e,this.bound[e])}},toElement:function(){this.node},render:$empty});A.Element.Field=new Class({Extends:A.Element,Implements:[Options],options:{classes:{loading:"ma-loading",selected:"ma-selected"}},initialize:function(I,H){this.keyPressControl={};this.boundEvents=["paste","focus","blur","click","keyup","keyrepeat"];if(G.trident4){this.boundEvents.push("keypress")}this.parent(I);this.setOptions(H);E(D).addEvent("unload",function(){this.node.set("autocomplete","on")}.bind(this))},setNode:function(H){this.parent(H);this.node.set("autocomplete","off")},keyrepeat:function(H){$clear(this.keyrepeatTimer);this.keyrepeatTimer=this._keyrepeat.delay(1,this,H)},_keyrepeat:function(H){this.fireEvent("delayedKeyrepeat",H)},destroy:function(){this.detach();this.node.removeAttribute("autocomplete")},addLoadingClass:function(){this.node.addClass(this.options.classes.loading)},removeLoadingClass:function(){this.node.removeClass(this.options.classes.loading)},addSelectedClass:function(){this.node.addClass(this.options.classes.selected)},removeSelectedClass:function(){this.node.removeClass(this.options.classes.selected)},keypress:function(H){if(H.key=="enter"){this.bound.keyrepeat(H)}}});A.Element.List=new Class({Extends:A.Element,Implements:[Options],options:{width:"field",classes:{container:"ma-container",hover:"ma-hover",odd:"ma-odd",even:"ma-even"}},initialize:function(H){this.boundEvents=["mousedown","mouseover"];this.parent();this.setOptions(H);this.focusedItem=null},applyMaxHeight:function(J){var H=this.list.childNodes;var I=H[J-1]||(H.length?H[H.length-1]:null);if(!I){return }I=E(I);this.node.setStyle("height",I.getCoordinates(this.list).bottom);this.node.setStyle("height",I.getCoordinates(this.list).bottom)},mouseover:function(I){var H=this.getItemFromEvent(I),J=this.options.classes.hover;if(!H){return true}if(this.focusedItem){this.focusedItem.removeClass(J)}H.addClass(J);this.focusedItem=H;this.fireEvent("focusItem",[this.focusedItem])},mousedown:function(H){H.preventDefault();this.shouldNotBlur=true;if(!(this.focusedItem=this.getItemFromEvent(H))){H.dontHide=true;return true}this.focusedItem.removeClass(this.options.classes.hover)},focusItem:function(I){var J=this.options.classes.hover,H;if(this.focusedItem){if((H=this.focusedItem[I=="up"?"getPrevious":"getNext"]())){this.focusedItem.removeClass(J);H.addClass(J);this.focusedItem=H;this.scrollFocusedItem(I)}}else{if((H=this.list.getFirst())){H.addClass(J);this.focusedItem=H}}},scrollFocusedItem:function(K){var H=this.focusedItem.getCoordinates(this.list),J=this.node.scrollTop;if(K=="down"){var L=H.bottom-this.node.getStyle("height").toInt();if((L-J)>0){this.node.scrollTop=L}}else{var I=H.top;if(J&&J>I){this.node.scrollTop=I}}},getItemFromEvent:function(I){var H=I.target;while(H&&H.tagName!="LI"){if(H===this.node){return null}H=H.parentNode}return E(H)},render:function(){var H=new Element("div",{"class":this.options.classes.container});if(H.bgiframe){H.bgiframe({top:0,left:0})}this.list=new Element("ul").inject(H);E(document.body).grab(H);return H},positionNextTo:function(H){var I=this.options.width;var J=H.getCoordinates();this.node.setStyle("width",I=="field"?H.getWidth().toInt()-this.node.getStyle("border-left-width").toInt()-this.node.getStyle("border-right-width").toInt():I);this.node.setPosition({x:J.left,y:J.bottom})},show:function(){this.node.scrollTop=0;this.node.setStyle("visibility","visible");this.showing=true},hide:function(){this.showing=false;this.node.setStyle("visibility","hidden")}});A.Autocomplete.Filter={filters:{},get:function(H){var I=H.type,K=H;if(I){var J=(H.path||"").split(".");if(this.filters[I]){K=this.filters[I](this,J)}}return $merge(this.defaults(J),K)},define:function(I,H){this.filters[I]=H},defaults:function(I){var H=this;return{filter:function(K,J){return K?H._getValueFromKeys(J,I).toLowerCase().contains(K):true},formatMatch:function(K,J){return H._getValueFromKeys(J,I)},formatItem:function(L,K,J){return L?H._getValueFromKeys(K,I).replace(new RegExp("("+L.escapeRegExp()+")","gi"),"<strong>$1</strong>"):H._getValueFromKeys(K,I)}}},_getValueFromKeys:function(L,J){var I,K=L;for(var H=0;I=J[H++];){K=K[I]}return K}};A.Autocomplete.Filter.define("contains",function(H,I){return{}});A.Autocomplete.Filter.define("startswith",function(H,I){return{filter:function(K,J){return K?H._getValueFromKeys(J,I).test(new RegExp("^"+K.escapeRegExp(),"i")):true}}});A.Autocomplete.Data=new Class({Implements:[Options,Events],initialize:function(I,H){this.data=I;this._cache=H},get:function(){return this.data},getKey:function(){return this.cachedKey},prepare:function(H){this.cachedKey=H;this.fireEvent("ready")},cache:function(H,I){this._cache.set(H,I)},refreshKey:$empty});A.Autocomplete.Data.Request=new Class({Extends:A.Autocomplete.Data,options:{noCache:true},initialize:function(K,I,L,J,H){this.setOptions(J);this.rawUrl=K;this._cache=I;this.element=L;this.urlOptions=H;this.refreshKey();this.createRequest()},prepare:function(H){this.cachedKey=this.url.evaluate(H);if(this._cache.has(this.cachedKey)){this.fireEvent("ready")}else{this.request.send({url:this.cachedKey})}},createRequest:function(){var H=this;this.request=new Request.JSON(this.options);this.request.addEvents({request:function(){H.element.addLoadingClass()},complete:function(){H.element.removeLoadingClass()},success:function(I){H.data=I;H.fireEvent("ready")}})},refreshKey:function(H){H=$merge(this.urlOptions,{url:this.rawUrl},H||{});this.url=new A.Autocomplete.Data.Request.URL(H.url,H)}});A.Autocomplete.Data.Request.URL=new Class({Implements:[Options],options:{extraParams:null,max:20},initialize:function(I,H){this.setOptions(H);this.rawUrl=I;this.url=I;this.url+=this.url.contains("?")?"&":"?";this.dynamicExtraParams=[];var K=$splat(this.options.extraParams);for(var J=K.length;J--;){this.addParameter(K[J])}if(this.options.max){this.addParameter("limit="+this.options.max)}},evaluate:function(K){K=K||"";var J=this.dynamicExtraParams,H=[];H.push("q="+encodeURIComponent(K));for(var I=J.length;I--;){H.push(encodeURIComponent(J[I].name)+"="+encodeURIComponent($lambda(J[I].value)()))}return this.url+H.join("&")},addParameter:function(H){if(isFinite(H.nodeType)||$type(H.value)=="function"){this.dynamicExtraParams.push(H)}else{this.url+=(($type(H)=="string")?H:encodeURIComponent(H.name)+"="+encodeURIComponent(H.value))+"&"}},removeParameter:function(H){this.dynamicExtraParams.erase(H)}});A.Autocomplete.Cache=new Class({initialize:function(H){this.refresh();this.setMaxLength(H)},set:function(H,I){if(!this.cache[H]){if(this.getLength()>=this.maxLength){var J=this.pos.shift();this.cache[J]=null;delete this.cache[J]}this.cache[H]=I;this.pos.push(H)}return this},get:function(H){return this.cache[H||""]||null},has:function(H){return !!this.get(H)},getLength:function(){return this.pos.length},refresh:function(){this.cache={};this.pos=[]},setMaxLength:function(H){this.maxLength=Math.max(H,1)}});F=new A.Autocomplete.Cache();if(typeof D.Meio=="undefined"){D.Meio=A}else{$extend(D.Meio,A)}})(this)